#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
pup: check PyPI for updates, since pip doesn't.
"""

import sys
import pip
import xmlrpclib
from cStringIO import StringIO
from distutils.version import StrictVersion, LooseVersion


def pip_freeze():
    """Run `pip freeze` and return a list of [package, version] lists."""
    sys.stdout = _stdout = StringIO()
    sys.stderr = _stderr = StringIO()

    pip.main(['freeze'])

    sys.stdout = sys.__stdout__
    sys.stderr = sys.__stderr__

    return filter(
        lambda p: len(p) >= 2,
        [p.split('==') for p in _stdout.getvalue().split('\n')]
    )


def remote_version(package):
    """For a given package, query PyPI and return the newest version number.
    """
    url = 'http://pypi.python.org/pypi'
    pypi = xmlrpclib.ServerProxy(url, xmlrpclib.Transport())
    hits = pypi.package_releases(package)
    return hits[0] if hits else '0'


def is_newer(ver1, ver2):
    """Return `True` if `ver1` is newer than `ver2`, otherwise return `False`.
    """
    try:
        return StrictVersion(ver1) > StrictVersion(ver2)
    except ValueError:
        return LooseVersion(ver1) > LooseVersion(ver2)


def find_updates(packages):
    """Return a list of (package_name, new_version, old_version) tuples."""
    updates = []

    for pkg, local_ver in packages:
        remote_ver = remote_version(pkg)
        if remote_ver and is_newer(remote_ver, local_ver):
            updates.append((pkg, remote_ver, local_ver))

    return updates


def main():
    """Identify installed packages with newer versions available and print the
    result.
    """
    print 'pup: checking PyPI for updates.'
    packages = pip_freeze()
    updates = find_updates(packages)

    columns = '\t{:20}    {:15}    {:15}'

    if updates:
        print 'packages with newer versions available:\n'
        print columns.format('package', 'available', 'current')
        print columns.format('-' * 20, '-' * 15, '-' * 15)
        for pkg, new, old in updates:
            print columns.format(pkg[:20], new[:15], old[:15])
        print
    else:
        print 'no updates available.'


if __name__ == '__main__':
    main()
